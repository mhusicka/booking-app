<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Vozík 24/7</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .admin-box { max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .login-screen { max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #bfa37c; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 12px; }
        tr:hover { background: #fafafa; }
        
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .b-paid { background: #d4edda; color: #155724; }
        .b-pending { background: #fff3cd; color: #856404; }
        .b-canceled { background: #f8d7da; color: #721c24; }

        .btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 5px; transition: 0.2s; }
        .btn-del { background: #ffebee; color: #c62828; }
        .btn-del:hover { background: #ffcdd2; }
        .btn-arch { background: #e3f2fd; color: #1565c0; }
        .btn-arch:hover { background: #bbdefb; }
        .btn-resend { background: #fff3e0; color: #ef6c00; }
        .btn-resend:hover { background: #ffe0b2; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-main { background: #bfa37c; color: white; padding: 12px 20px; font-size: 16px; width: 100%; font-weight: bold; }
        .btn-main:hover { background: #a68b68; }

        /* NOVÉ STYLY PRO FILTRY A DASHBOARD */
        .dashboard-stats { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; }
        .stat-card { background: #333; color: #fff; padding: 15px 25px; border-radius: 8px; min-width: 200px; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 12px; text-transform: uppercase; color: #aaa; }
        .stat-card .value { font-size: 24px; font-weight: 800; color: #bfa37c; }

        .month-filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .filter-btn { background: white; border: 1px solid #ddd; color: #555; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 13px; transition: all 0.2s; }
        .filter-btn:hover { border-color: #bfa37c; color: #bfa37c; }
        .filter-btn.active { background: #bfa37c; color: white; border-color: #bfa37c; }

        /* Zvýraznění aktivní rezervace */
        tr.active-now { background: #e8f5e9; border-left: 4px solid #28a745; }
    </style>
</head>
<body>

    <div id="login-section" class="login-screen">
        <h2>Admin přihlášení</h2>
        <input type="password" id="admin-pass" placeholder="Heslo" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px;">
        <button onclick="login()" class="btn btn-main">Vstoupit</button>
    </div>

    <div id="admin-content" style="display: none;">
        
        <div class="admin-box">
            <h1>Rezervace <button onclick="logout()" class="btn btn-del">Odhlásit</button></h1>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <h3 id="revenue-title">Celková tržba (Zaplaceno)</h3>
                    <div class="value" id="total-revenue">0 Kč</div>
                </div>
                <div class="stat-card" style="background: white; border: 1px solid #ddd; color: #333;">
                    <h3>Počet rezervací</h3>
                    <div class="value" id="res-count" style="color: #333">0</div>
                </div>
            </div>

            <div class="month-filters" id="month-filters-container">
                </div>

            <table id="res-table">
                <thead>
                    <tr>
                        <th>Vytvořeno</th>
                        <th>Termín</th>
                        <th>Jméno</th>
                        <th>Telefon / Email</th>
                        <th>PIN</th>
                        <th>Cena</th>
                        <th>Stav</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="admin-box" style="max-width: 600px;">
            <h2>Ruční vytvoření rezervace</h2>
            <div class="input-group"><label>Jméno</label><input id="admin-name" type="text"></div>
            <div class="input-group"><label>Email</label><input id="admin-email" type="email"></div>
            <div class="input-group"><label>Telefon</label><input id="admin-phone" type="text" value="+420 "></div>
            <div class="input-group" style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Od</label><input id="admin-start" type="date"></div>
                <div style="flex:1"><label>Do</label><input id="admin-end" type="date"></div>
            </div>
            <div class="input-group"><label>Čas</label><input id="admin-time" type="time" value="08:00"></div>
            <div class="input-group"><label>Cena (Kč)</label><input id="admin-price" type="number"></div>
            <button onclick="manualReserve()" class="btn btn-main">Vytvořit a poslat PIN</button>
        </div>
    </div>

    <script>
        let allReservations = []; // Zde si uložíme všechna data

        function login() {
            const p = document.getElementById("admin-pass").value;
            localStorage.setItem("adminPass", p);
            checkAuth();
        }

        function logout() {
            localStorage.removeItem("adminPass");
            location.reload();
        }

        async function checkAuth() {
            const pass = localStorage.getItem("adminPass");
            if (!pass) return;

            const res = await fetch("/admin/reservations", { headers: { "x-admin-password": pass } });
            if (res.status === 403) {
                alert("Špatné heslo");
                localStorage.removeItem("adminPass");
                return;
            }
            
            allReservations = await res.json(); // Uložíme si data globálně
            
            document.getElementById("login-section").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            
            generateFilters(); // Vygenerujeme tlačítka měsíců
            renderTable(allReservations); // Zobrazíme vše
        }

        // --- NOVÁ FUNKCE: Generování filtrů ---
        function generateFilters() {
            const container = document.getElementById('month-filters-container');
            container.innerHTML = `<button class="filter-btn active" onclick="filterData('ALL', this)">VŠE</button>`;

            // Získáme unikátní měsíce z dat (formát YYYY-MM)
            const months = new Set();
            allReservations.forEach(r => {
                if(r.startDate) months.add(r.startDate.substring(0, 7));
            });

            // Seřadíme od nejnovějšího
            const sortedMonths = Array.from(months).sort().reverse();

            // Názvy měsíců
            const monthNames = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"];

            sortedMonths.forEach(m => {
                const [year, month] = m.split('-');
                const label = `${monthNames[parseInt(month) - 1]} ${year}`;
                container.innerHTML += `<button class="filter-btn" onclick="filterData('${m}', this)">${label}</button>`;
            });
        }

        // --- NOVÁ FUNKCE: Filtrování dat ---
        function filterData(monthKey, btnElement) {
            // Přepnutí třídy active
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            let filtered;
            const titleEl = document.getElementById('revenue-title');

            if (monthKey === 'ALL') {
                filtered = allReservations;
                titleEl.innerText = "Celková tržba (Zaplaceno)";
            } else {
                filtered = allReservations.filter(r => r.startDate.startsWith(monthKey));
                const [year, month] = monthKey.split('-');
                const monthNames = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"];
                titleEl.innerText = `Tržba: ${monthNames[parseInt(month) - 1]} ${year}`;
            }

            renderTable(filtered);
        }

        function renderTable(data) {
            const tbody = document.querySelector("#res-table tbody");
            tbody.innerHTML = "";

            // Výpočet tržby (POUZE 'PAID' status)
            const total = data.reduce((sum, r) => (r.paymentStatus === 'PAID' ? sum + (r.price || 0) : sum), 0);
            document.getElementById("total-revenue").innerText = total.toLocaleString("cs-CZ") + " Kč";
            document.getElementById("res-count").innerText = data.length;

            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];

            data.forEach(r => {
                // Určení barvy statusu
                let statusClass = "b-pending";
                let statusText = "Čeká";
                if (r.paymentStatus === 'PAID') { statusClass = "b-paid"; statusText = "Zaplaceno"; }
                if (r.paymentStatus === 'CANCELED') { statusClass = "b-canceled"; statusText = "Zrušeno"; }

                // Zvýraznění probíhající rezervace
                const isActive = (r.startDate <= todayStr && r.endDate >= todayStr && r.paymentStatus === 'PAID');
                const rowClass = isActive ? 'active-now' : '';

                const tr = document.createElement("tr");
                tr.className = rowClass;
                tr.innerHTML = `
                    <td>${new Date(r.created).toLocaleDateString("cs-CZ")}<br><small>${new Date(r.created).toLocaleTimeString("cs-CZ")}</small></td>
                    <td><b>${new Date(r.startDate).toLocaleDateString("cs-CZ")} - ${new Date(r.endDate).toLocaleDateString("cs-CZ")}</b><br><small>${r.time}</small></td>
                    <td>${r.name}</td>
                    <td>${r.phone}<br><small>${r.email}</small></td>
                    <td style="font-family:monospace; font-size:16px;">${r.passcode}</td>
                    <td>${r.price} Kč</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button onclick="resendEmail('${r._id}')" class="btn btn-resend" title="Přeposlat email"><i class="fa-regular fa-envelope"></i></button>
                        <button onclick="archiveRes('${r._id}')" class="btn btn-arch" title="Ukončit/Archivovat"><i class="fa-solid fa-box-archive"></i></button>
                        <button onclick="deleteRes('${r._id}')" class="btn btn-del" title="Smazat"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function resendEmail(id) {
            if(!confirm("Znovu odeslat email s PINem a fakturou?")) return;
            const res = await fetch(`/admin/reservations/${id}/resend-email`, { method: "POST", headers: { "x-admin-password": localStorage.getItem("adminPass") } });
            if (res.ok) alert("Odesláno");
        }

        async function deleteRes(id) {
            if(!confirm("Opravdu SMAZAT záznam? Zmizí z historie i z účetnictví.")) return;
            await fetch(`/admin/reservations/${id}`, { method: "DELETE", headers: { "x-admin-password": localStorage.getItem("adminPass") } });
            checkAuth(); // Refresh
        }

        async function archiveRes(id) {
            if(!confirm("Archivovat? PIN kód přestane platit.")) return;
            await fetch(`/admin/reservations/${id}/archive`, { method: "POST", headers: { "x-admin-password": localStorage.getItem("adminPass") } });
            checkAuth(); // Refresh
        }

        async function manualReserve() {
            const body = {
                startDate: document.getElementById("admin-start").value,
                endDate: document.getElementById("admin-end").value,
                time: document.getElementById("admin-time").value,
                name: document.getElementById("admin-name").value,
                email: document.getElementById("admin-email").value,
                phone: document.getElementById("admin-phone").value,
                price: document.getElementById("admin-price").value
            };
            await fetch("/reserve-range", { 
                method: "POST", 
                headers: { "Content-Type": "application/json", "x-admin-password": localStorage.getItem("adminPass") }, 
                body: JSON.stringify(body) 
            });
            alert("Rezervace vytvořena");
            checkAuth();
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
