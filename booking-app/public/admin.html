<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Voz√≠k 24/7</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        /* Box na celou ≈°√≠≈ôku */
        .admin-box { max-width: 100%; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .login-screen { max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #bfa37c; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        
        /* --- STANDARDN√ç TABULKA (DESKTOP) --- */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 11px; cursor: pointer; user-select: none; }
        th:hover { background: #e9ecef; color: #333; }
        th i { margin-left: 5px; color: #aaa; }
        tr:hover { background: #fafafa; }
        
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .b-paid { background: #d4edda; color: #155724; }
        .b-pending { background: #fff3cd; color: #856404; }
        .b-canceled { background: #f8d7da; color: #721c24; }

        .pin-stat { font-weight: 700; font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .pin-active { color: #28a745; } 
        .pin-wait { color: #fd7e14; }
        .pin-end { color: #aaa; }
        .pin-manual { color: #333; text-decoration: line-through; }

        .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 3px; transition: 0.2s; }
        .btn-del { background: #ffebee; color: #c62828; }
        .btn-del:hover { background: #ffcdd2; }
        .btn-arch { background: #e3f2fd; color: #1565c0; } 
        .btn-arch:hover { background: #bbdefb; }
        
        .btn-restore { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .btn-restore:hover { background: #c8e6c9; }

        .btn-resend { background: #fff3e0; color: #ef6c00; }
        .btn-resend:hover { background: #ffe0b2; }
        .btn-pay-link { background: #e3f2fd; color: #0d47a1; }
        .btn-pay-link:hover { background: #bbdefb; }
        .btn-edit { background: #e8f5e9; color: #2e7d32; }
        .btn-edit:hover { background: #c8e6c9; }
        
        .btn-export { background: #28a745; color: white; padding: 8px 16px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-export:hover { background: #218838; }

        .btn-save-contact { background: #333; color: white; padding: 12px; font-size: 11px; border-radius: 4px; margin-top: 10px; width: 100%; border: none; cursor: pointer; font-weight: 600; text-transform: uppercase; }
        .btn-save-contact:hover { background: #555; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-main { background: #bfa37c; color: white; padding: 12px 20px; font-size: 16px; width: 100%; font-weight: bold; border: none; cursor: pointer; border-radius: 6px; }
        .btn-main:hover { background: #a68b68; }

        .dashboard-stats { display: flex; gap: 15px; margin-bottom: 20px; align-items: stretch; flex-wrap: wrap; }
        .stat-card { background: white; border: 1px solid #eee; padding: 15px 20px; border-radius: 8px; min-width: 180px; flex: 1; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 11px; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .stat-card .value { font-size: 20px; font-weight: 800; color: #333; }
        
        .card-dark { background: #333; color: white; border: none; }
        .card-dark .value { color: #bfa37c; }
        .card-red { background: #fff5f5; border: 1px solid #ffcdd2; }
        .card-red .value { color: #dc3545; }
        .card-orange { background: #fff8e1; border: 1px solid #ffe0b2; }
        .card-orange .value { color: #fd7e14; }
        .card-green { background: #e8f5e9; border: 1px solid #c8e6c9; }
        .card-green .value { color: #28a745; }
        
        .month-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .filter-btn { background: white; border: 1px solid #ddd; color: #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; }
        .filter-btn:hover { border-color: #bfa37c; color: #bfa37c; }
        .filter-btn.active { background: #bfa37c; color: white; border-color: #bfa37c; }

        .settings-bar { display: flex; align-items: center; gap: 10px; background: #f1f3f5; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; border: 1px solid #dee2e6; flex-wrap: wrap; }
        .settings-bar div { display: flex; align-items: center; gap: 8px; }
        .settings-bar input { width: 80px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }
        .btn-save-settings { background: #333; color: white; padding: 8px 15px; border-radius: 6px; font-weight: bold; margin-left: auto; border: none; cursor: pointer; }

        tr.active-now { background: #e8f5e9; border-left: 4px solid #28a745; }
        .col-id { font-family: monospace; font-weight: bold; color: #bfa37c; font-size: 14px; text-decoration: none; border-bottom: 1px dashed #bfa37c; }
        .col-id:hover { color: #a68b68; border-bottom-style: solid; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 30px; border-radius: 12px; width: 400px; max-width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }
        .modal-box h2 { margin-top: 0; color: #333; border-bottom: 2px solid #bfa37c; display: inline-block; padding-bottom: 5px; }
        .btn-pay { background: #007bff; color: white; }
        .btn-pay:hover { background: #0056b3; }

        /* --- DESKTOP ROZLO≈ΩEN√ç --- */
        .manual-container { display: flex; gap: 20px; flex-wrap: wrap; align-items: stretch; width: 100%; }
        .manual-form { flex: 1; min-width: 320px; display: flex; flex-direction: column; }
        .manual-calendar { flex: 1; background: #f8f9fa; padding: 15px; border-radius: 12px; border: 1px solid #eee; box-sizing: border-box; display: flex; flex-direction: column; }

        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-header h3 { font-size: 12px; margin: 0; }
        
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-auto-rows: 1fr; gap: 2px; flex-grow: 1; min-height: 0; }
        .cal-weekday { text-align: center; font-size: 10px; font-weight: bold; color: #aaa; padding-bottom: 4px; display: flex; align-items: flex-end; justify-content: center; }
        
        .cal-day { background: white; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; border: 1px solid #ddd; transition: 0.2s; }
        .cal-day:hover { border-color: #bfa37c; }
        .cal-day.empty { background: transparent; border: none; cursor: default; }
        .cal-day.past { color: #ccc; cursor: not-allowed; background: #f9f9f9; }
        .cal-day.selected { border: 2px solid #333; }
        .cal-day.today { font-weight: 800; color: #333; border: 2px solid #bfa37c; }
        
        .customer-edit-section { border-top: 1px solid #eee; margin-top: 20px; padding-top: 10px; }
        .customer-edit-section h3 { font-size: 14px; text-transform: uppercase; color: #888; margin-bottom: 10px; }

        /* --- MOBILN√ç OPTIMALIZACE (RESPONZIVITA) --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .admin-box { padding: 15px; }
            
            h1 { flex-direction: column; align-items: flex-start; gap: 10px; }
            h1 span { font-size: 18px; }
            h1 div { width: 100%; display: flex; gap: 5px; }
            h1 button { flex: 1; justify-content: center; }

            /* Zmen≈°en√≠ paddingu kalend√°≈ôe, aby nep≈ôeƒçuhoval */
            .manual-calendar { padding: 8px; min-width: 100%; min-height: 350px; }
            .cal-day { font-size: 10px; }

            .manual-container { flex-direction: column; }
            .manual-form { min-width: 100%; }

            .settings-bar { flex-direction: column; align-items: stretch; }
            .settings-bar div { justify-content: space-between; margin-left: 0 !important; margin-bottom: 10px; }
            .btn-save-settings { width: 100%; margin-top: 10px; }

            .modal-box { padding: 20px; width: 95%; }

            /* --- KARTY M√çSTO TABULKY (CARD VIEW) --- */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; } /* Skryt√≠ hlaviƒçky */
            
            tr {
                margin-bottom: 15px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                padding: 10px;
            }
            
            td {
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 40%; /* M√≠sto pro popisek */
                padding-top: 8px;
                padding-bottom: 8px;
                text-align: right; /* Hodnoty vpravo */
                min-height: 25px;
                display: flex;
                align-items: center;
                justify-content: flex-end;
            }
            
            td:last-child { border-bottom: none; justify-content: center; padding-left: 0; padding-top: 15px; }

            /* Pomoc√≠ pseudo-elementu p≈ôid√°me n√°zev sloupce p≈ôed hodnotu */
            td:before {
                position: absolute;
                top: 50%;
                left: 10px;
                transform: translateY(-50%);
                width: 35%;
                white-space: nowrap;
                content: attr(data-label); /* Zde si vezme text z atributu data-label */
                font-weight: 700;
                color: #888;
                font-size: 11px;
                text-transform: uppercase;
                text-align: left;
            }
            
            /* Specifick√© √∫pravy pro vzhled v kartƒõ */
            .col-id { font-size: 16px; border: none; }
            td[data-label="Akce"] { gap: 10px; }
            .btn { padding: 8px 12px; font-size: 14px; }
        }
    </style>
</head>
<body>

    <div id="edit-modal" class="modal-overlay" style="display: none;">
        <div class="modal-box">
            <h2>Upravit rezervaci</h2>
            <input type="hidden" id="edit-id">
            <input type="hidden" id="edit-original-price">
            
            <div class="input-group"><label>Datum Od:</label><input type="date" id="edit-start"></div>
            <div class="input-group"><label>Datum Do:</label><input type="date" id="edit-end"></div>
            <div class="input-group"><label>ƒåas:</label><input type="time" id="edit-time"></div>
            <div class="input-group"><label>ƒåas vr√°cen√≠ (nepovinn√©):</label><input type="time" id="edit-endtime"></div>
            
            <div class="customer-edit-section">
                <h3>√ödaje z√°kazn√≠ka</h3>
                <div class="input-group"><label>Jm√©no:</label><input type="text" id="edit-name"></div>
                <div class="input-group"><label>Email:</label><input type="text" id="edit-email"></div>
                <div class="input-group"><label>Telefon:</label><input type="text" id="edit-phone"></div>
                <button onclick="saveContactInfoOnly()" class="btn-save-contact"><i class="fa-solid fa-floppy-disk"></i> ULO≈ΩIT JEN KONTAKTY</button>
            </div>

            <div class="input-group" style="background: #f9f9f9; padding: 10px; border-radius: 5px;">
                <label>Nov√° celkov√° cena (Kƒç):</label>
                <input type="number" id="edit-price" oninput="calcDiff()">
                <div id="price-diff" style="font-size: 12px; color: #555; margin-top: 5px; font-weight: bold;"></div>
            </div>

            <p style="font-size:12px; color:#666;">
                <strong>Mo≈ænost A (Ulo≈æit zdarma):</strong> Zmƒõn√≠ data hned a po≈°le nov√Ω PIN (i na nov√Ω email).<br>
                <strong>Mo≈ænost B (Vy≈æ√°dat doplatek):</strong> Po≈°le klientovi odkaz na platbu.
            </p>
            
            <div style="display:flex; flex-direction: column; gap:10px;">
                <button onclick="saveEditFree()" class="btn btn-main" style="background: #28a745;">A) Ulo≈æit zmƒõny (ZDARMA)</button>
                <button onclick="saveEditPayment()" class="btn btn-main btn-pay">B) Poslat v√Ωzvu k doplatku</button>
                <button onclick="closeEditModal()" class="btn btn-del" style="background:#ddd; color:#333;">Zru≈°it</button>
            </div>
        </div>
    </div>

    <div id="login-section" class="login-screen">
        <h2>Admin p≈ôihl√°≈°en√≠</h2>
        <input type="password" id="admin-pass" placeholder="Heslo" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px;">
        <button onclick="login()" class="btn btn-main">Vstoupit</button>
    </div>

    <div id="admin-content" style="display: none;">
        
        <div class="admin-box">
            <h1>
                <span><i class="fa-solid fa-chart-line"></i> P≈ôehled rezervac√≠</span>
                <div>
                    <button onclick="downloadCSV()" class="btn btn-export"><i class="fa-solid fa-file-excel"></i> Export</button>
                    <button onclick="logout()" class="btn btn-del">Odhl√°sit</button>
                </div>
            </h1>

            <div class="settings-bar">
                <div>
                    <i class="fa-solid fa-calculator"></i>
                    <label>Da≈à z p≈ô√≠jmu:</label>
                    <input type="number" id="tax-rate" value="15" onchange="recalculateAll()"> %
                </div>
                <div style="margin-left: 20px;">
                    <i class="fa-solid fa-tag"></i>
                    <label>Z√°kladn√≠ cena (24h):</label>
                    <input type="number" id="daily-price" value="230" onchange="updateManualPriceHint()"> Kƒç
                </div>
                <button onclick="saveGlobalSettings()" class="btn btn-save-settings"><i class="fa-solid fa-floppy-disk"></i> ULO≈ΩIT GLOB√ÅLN√ç NASTAVEN√ç</button>
            </div>

            <div class="month-filters" id="month-filters-container"></div>

            <div class="dashboard-stats">
                <div class="stat-card card-dark">
                    <h3 id="revenue-title">Celkov√° tr≈æba (Hrub√°)</h3>
                    <div class="value" id="total-revenue">0 Kƒç</div>
                </div>
                <div class="stat-card card-red">
                    <h3>Poplatky (GoPay)</h3>
                    <div class="value" id="total-fees">0 Kƒç</div>
                    <small style="font-size: 10px; color: #666;">Auto-limit 50 000 Kƒç</small>
                </div>
                <div class="stat-card card-orange">
                    <h3>Odhad danƒõ</h3>
                    <div class="value" id="total-tax">0 Kƒç</div>
                </div>
                <div class="stat-card card-green">
                    <h3>ƒåist√Ω zisk (Netto)</h3>
                    <div class="value" id="total-net">0 Kƒç</div>
                </div>
                <div class="stat-card">
                    <h3>Poƒçet rezervac√≠</h3>
                    <div class="value" id="res-count">0</div>
                </div>
            </div>

            <table id="res-table">
                <thead>
                    <tr>
                        <th onclick="sortData('created')">Vytvo≈ôeno <i class="fa-solid fa-sort"></i></th>
                        <th onclick="sortData('reservationCode')">ID <i class="fa-solid fa-sort"></i></th>
                        <th onclick="sortData('name')">Jm√©no <i class="fa-solid fa-sort"></i></th>
                        <th onclick="sortData('email')">Email <i class="fa-solid fa-sort"></i></th>
                        <th>Telefon</th>
                        <th onclick="sortData('startDate')">Term√≠n <i class="fa-solid fa-sort"></i></th>
                        <th onclick="sortData('price')">Cena <i class="fa-solid fa-sort"></i></th>
                        <th style="color:#dc3545">GoPay</th>
                        <th style="color:#fd7e14">Da≈à</th>
                        <th style="color:#28a745">ƒåist√Ω zisk</th>
                        <th>PIN</th>
                        <th>Stav PINu</th>
                        <th onclick="sortData('paymentStatus')">Stav <i class="fa-solid fa-sort"></i></th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="admin-box">
            <div class="manual-container">
                <div class="manual-form">
                    <h2><i class="fa-solid fa-plus-circle"></i> Ruƒçn√≠ vytvo≈ôen√≠ rezervace</h2>
                    <div class="input-group"><label>Jm√©no</label><input id="admin-name" type="text" autocomplete="off"></div>
                    <div class="input-group"><label>Email</label><input id="admin-email" type="email" autocomplete="off"></div>
                    <div class="input-group"><label>Telefon</label><input id="admin-phone" type="text" value="+420 " autocomplete="off"></div>
                    <div class="input-group" style="display: flex; gap: 10px;">
                        <div style="flex:1"><label>Od</label><input id="admin-start" type="date" onchange="updateManualPriceHint()"></div>
                        <div style="flex:1"><label>Do</label><input id="admin-end" type="date" onchange="updateManualPriceHint()"></div>
                    </div>
                    <div class="input-group"><label>ƒåas vyzvednut√≠</label><input id="admin-time" type="time" value="06:00"></div>
                    <div class="input-group">
                        <label>Cena (Kƒç)</label>
                        <input id="admin-price" type="number" value="235">
                        <small id="price-hint" style="color: #888; display: block; margin-top: 4px;"></small>
                    </div>
                    <button onclick="manualReserve()" class="btn btn-main">Vytvo≈ôit a poslat PIN</button>
                </div>

                <div class="manual-calendar">
                    <div class="cal-header">
                        <button onclick="changeAdminMonth(-1)" class="btn"><i class="fa-solid fa-chevron-left"></i></button>
                        <h3 id="admin-cal-month" style="margin:0; text-transform:uppercase; font-size:14px; letter-spacing:1px;">...</h3>
                        <button onclick="changeAdminMonth(1)" class="btn"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                    <div class="cal-grid" id="admin-cal-grid"></div>
                    <div style="margin-top:10px; font-size:10px; color:#666; display:flex; gap:10px; flex-wrap:wrap;">
                        <span><i class="fa-solid fa-square" style="color:#bfa37c"></i> Obsazeno</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allReservations = []; 
        let currentFilteredData = [];
        let computedDataMap = {}; 
        
        let sortConfig = { key: 'created', dir: 'desc' };
        
        let viewMonth = new Date().getMonth();
        let viewYear = new Date().getFullYear();

        const STANDARD_PERCENT = 0.01;
        const STANDARD_FIXED = 1;
        const CPK_LIMIT = 50000;

        function login() {
            const p = document.getElementById("admin-pass").value;
            localStorage.setItem("adminPass", p);
            checkAuth();
        }
        function logout() { localStorage.removeItem("adminPass"); location.reload(); }

        async function checkAuth() {
            const pass = localStorage.getItem("adminPass");
            if (!pass) return;
            try {
                const res = await fetch("/admin/reservations", { headers: { "x-admin-password": pass } });
                if (res.status === 403) { alert("≈†patn√© heslo"); localStorage.removeItem("adminPass"); return; }
                allReservations = await res.json(); 
                
                document.getElementById("login-section").style.display = "none";
                document.getElementById("admin-content").style.display = "block";
                
                const savedTax = localStorage.getItem("taxRate");
                if (savedTax) document.getElementById("tax-rate").value = savedTax;
                
                const savedPrice = localStorage.getItem("dailyPrice") || "235";
                document.getElementById("daily-price").value = savedPrice;

                calculateFeesGlobal();
                generateFilters();
                renderAdminCalendar();
                
                const activeBtn = document.querySelector('.filter-btn.active');
                filterData(activeBtn ? activeBtn.getAttribute('data-month') : 'ALL', activeBtn);
            } catch(e) {
                console.error("Chyba naƒç√≠t√°n√≠ dat:", e);
                document.getElementById("login-section").style.display = "none";
                document.getElementById("admin-content").style.display = "block";
            }
        }

        async function saveGlobalSettings() {
            const tax = document.getElementById("tax-rate").value;
            const price = document.getElementById("daily-price").value;
            localStorage.setItem("taxRate", tax);
            localStorage.setItem("dailyPrice", price);
            try {
                await fetch("/admin/settings", {
                    method: "POST", headers: { "Content-Type": "application/json", "x-admin-password": localStorage.getItem("adminPass") },
                    body: JSON.stringify({ taxRate: tax, dailyPrice: price })
                });
                alert("Ulo≈æeno."); recalculateAll();
            } catch(e) { alert("Chyba."); }
        }

        function updateManualPriceHint() {
            const start = document.getElementById("admin-start").value;
            const end = document.getElementById("admin-end").value;
            const daily = parseFloat(document.getElementById("daily-price").value) || 0;
            if (start && end) {
                const diff = Math.ceil((new Date(end) - new Date(start)) / (1000 * 60 * 60 * 24)) || 1;
                document.getElementById("admin-price").value = diff * daily;
                document.getElementById("price-hint").innerText = `V√Ωpoƒçet: ${diff} den/dny x ${daily} Kƒç = ${diff * daily} Kƒç`;
            }
        }

        function getMonthName(mIndex) {
            const monthNames = ["Leden", "√önor", "B≈ôezen", "Duben", "Kvƒõten", "ƒåerven", "ƒåervenec", "Srpen", "Z√°≈ô√≠", "≈ò√≠jen", "Listopad", "Prosinec"];
            return monthNames[mIndex];
        }

        function calculateFeesGlobal() {
            computedDataMap = {};
            const monthlyRevenue = {};
            const chronological = [...allReservations].sort((a,b) => new Date(a.startDate) - new Date(b.startDate));
            chronological.forEach(r => {
                if (r.paymentStatus !== 'PAID') { computedDataMap[r._id] = { fee: 0, tax: 0, net: 0 }; return; }
                const mKey = r.startDate.substring(0, 7);
                if (!monthlyRevenue[mKey]) monthlyRevenue[mKey] = 0;
                let price = r.price || 0;
                let fee = (monthlyRevenue[mKey] < CPK_LIMIT) ? 0 : Math.round(price * STANDARD_PERCENT + STANDARD_FIXED);
                const taxRate = parseFloat(document.getElementById("tax-rate").value) || 0;
                let tax = Math.round(price * (taxRate / 100));
                computedDataMap[r._id] = { fee, tax, net: price - fee - tax };
                monthlyRevenue[mKey] += price;
            });
        }

        function recalculateAll() { calculateFeesGlobal(); const activeBtn = document.querySelector('.filter-btn.active'); if (activeBtn) activeBtn.click(); else filterData('ALL', null); }

        function generateFilters() {
            const container = document.getElementById('month-filters-container');
            container.innerHTML = `<button class="filter-btn active" data-month="ALL" onclick="filterData('ALL', this)">V≈†E</button>`;
            const months = new Set();
            allReservations.forEach(r => { if(r.startDate) months.add(r.startDate.substring(0, 7)); });
            Array.from(months).sort().reverse().forEach(m => {
                const [year, month] = m.split('-');
                const label = `${getMonthName(parseInt(month) - 1)} ${year}`;
                container.innerHTML += `<button class="filter-btn" data-month="${m}" onclick="filterData('${m}', this)">${label}</button>`;
            });
        }

        function sortData(key) {
            if (sortConfig.key === key) {
                sortConfig.dir = sortConfig.dir === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.dir = 'asc';
            }
            applySortAndRender();
        }

        function applySortAndRender() {
            currentFilteredData.sort((a, b) => {
                let valA = a[sortConfig.key];
                let valB = b[sortConfig.key];
                if (valA === undefined || valA === null) valA = "";
                if (valB === undefined || valB === null) valB = "";
                if (['created', 'startDate'].includes(sortConfig.key)) {
                    valA = valA ? new Date(valA).getTime() : 0;
                    valB = valB ? new Date(valB).getTime() : 0;
                }
                if (sortConfig.key === 'price') {
                    valA = Number(valA) || 0;
                    valB = Number(valB) || 0;
                }
                if (valA < valB) return sortConfig.dir === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.dir === 'asc' ? 1 : -1;
                return 0;
            });
            renderTable(currentFilteredData);
        }

        function filterData(monthKey, btnElement) {
            if(btnElement) { document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btnElement.classList.add('active'); }
            const titleEl = document.getElementById('revenue-title');
            if (monthKey === 'ALL') {
                currentFilteredData = [...allReservations];
                titleEl.innerText = "Celkov√° tr≈æba (Hrub√°)";
            } else {
                currentFilteredData = allReservations.filter(r => r.startDate.startsWith(monthKey));
                const [year, month] = monthKey.split('-');
                titleEl.innerText = `Tr≈æba: ${getMonthName(parseInt(month) - 1)} ${year}`;
            }
            applySortAndRender();
        }

        function renderTable(data) {
            const tbody = document.querySelector("#res-table tbody");
            tbody.innerHTML = "";
            let tRev = 0, tFee = 0, tTax = 0, tNet = 0;
            
            data.forEach(r => {
                let statusClass = "b-pending", statusText = "ƒåek√°";
                let vals = computedDataMap[r._id] || { fee: 0, tax: 0, net: 0 };
                
                let pendingInfoHtml = "";
                if (r.pendingExtension && r.pendingExtension.active) {
                    statusText = "Doplatek...";
                    statusClass = "b-pending";
                    const pendingDate = `${new Date(r.pendingExtension.newStartDate).toLocaleDateString("cs-CZ")} - ${new Date(r.pendingExtension.newEndDate).toLocaleDateString("cs-CZ")}`;
                    pendingInfoHtml = `<div style="font-size:9px; margin-top:3px; color:#d35400;">N√°vrh: ${pendingDate}<br>+${r.pendingExtension.surcharge} Kƒç</div>`;
                } else if (r.paymentStatus === 'PAID') { 
                    statusClass = "b-paid"; statusText = "Zaplaceno"; 
                    tRev += (r.price || 0); tFee += vals.fee; tTax += vals.tax; tNet += vals.net;
                } else if (r.paymentStatus === 'CANCELED') { 
                    statusClass = "b-canceled"; statusText = "Zru≈°eno"; 
                }

                const todayStr = new Date().toISOString().split('T')[0];
                const isActive = (r.startDate <= todayStr && r.endDate >= todayStr && r.paymentStatus === 'PAID');
                
                const d = new Date(r.created);
                const dateStr = d.toLocaleDateString("cs-CZ");
                const timeStr = d.toLocaleTimeString("cs-CZ", {hour: '2-digit', minute:'2-digit'});
                const createdHtml = `${dateStr}<br><small style="color:#888">${timeStr}</small>`;

                const endTimeDisplay = r.endTime || r.time;
                const termStr = `<span style="color:#555">${new Date(r.startDate).toLocaleDateString("cs-CZ")}</span> <b>${r.time}</b><br><small>do</small> <span style="color:#555">${new Date(r.endDate).toLocaleDateString("cs-CZ")}</span> <b>${endTimeDisplay}</b>`;

                const now = new Date();
                const startDt = new Date(r.startDate + 'T' + r.time);
                const endDt = new Date(r.endDate + 'T' + endTimeDisplay);
                
                let pinHtml = (now < startDt) ? '<span class="pin-stat pin-wait">‚è≥ ƒåek√°</span>' : (now <= endDt && r.paymentStatus === 'PAID') ? '<span class="pin-stat pin-active">üü¢ Aktivn√≠</span>' : '<span class="pin-stat pin-end">‚ö´ Ukonƒçen</span>';
                if (r.paymentStatus === 'CANCELED') pinHtml = '<span class="pin-stat pin-end">Zru≈°eno</span>';
                if (!r.keyboardPwdId && r.paymentStatus !== 'CANCELED') pinHtml = '<span class="pin-stat pin-manual">‚ö´ Ruƒçnƒõ</span>';

                const tr = document.createElement("tr");
                tr.className = isActive ? 'active-now' : '';
                const checkLink = `<a href="/check.html?id=${r.reservationCode}" target="_blank" class="col-id" title="Zobrazit jako z√°kazn√≠k">${r.reservationCode || '???'}</a>`;

                let actionBtn = "";
                if (r.keyboardPwdId && r.paymentStatus === 'PAID') {
                     actionBtn = `<button onclick="archiveRes('${r._id}')" class="btn btn-arch" title="Ukonƒçit rezervaci"><i class="fa-solid fa-lock-open"></i></button>`;
                } else if (!r.keyboardPwdId && r.paymentStatus === 'PAID') {
                     actionBtn = `<button onclick="renewRes('${r._id}')" class="btn btn-restore" title="Obnovit PIN"><i class="fa-solid fa-lock"></i></button>`;
                }

                // ZDE JSOU P≈òID√ÅNY ATRIBUTY DATA-LABEL PRO MOBILN√ç ZOBRAZEN√ç
                tr.innerHTML = `
                    <td data-label="Vytvo≈ôeno">${createdHtml}</td>
                    <td data-label="ID">${checkLink}</td>
                    <td data-label="Jm√©no"><b>${r.name || '-'}</b></td>
                    <td data-label="Email" style="font-size:11px">${r.email || '-'}</td>
                    <td data-label="Telefon" style="font-size:11px">${r.phone || '-'}</td>
                    <td data-label="Term√≠n" style="font-size:12px">${termStr}</td>
                    <td data-label="Cena" style="font-weight:bold">${r.price} Kƒç</td>
                    <td data-label="GoPay" style="color:#dc3545">-${vals.fee} Kƒç</td>
                    <td data-label="Da≈à" style="color:#fd7e14">-${vals.tax} Kƒç</td>
                    <td data-label="ƒåist√Ω zisk" style="color:#28a745; font-weight:bold">${vals.net} Kƒç</td>
                    <td data-label="PIN" style="font-family:monospace;">${r.passcode || '-'}</td>
                    <td data-label="Stav PINu">${pinHtml}</td>
                    <td data-label="Stav">
                        <span class="badge ${statusClass}">${statusText}</span>
                        ${pendingInfoHtml}
                    </td>
                    <td data-label="Akce" style="display:flex; gap:3px;">
                        <button onclick='openEditModal(${JSON.stringify(r)})' class="btn btn-edit"><i class="fa-solid fa-pen"></i></button>
                        ${(r.pendingExtension && r.pendingExtension.active) 
                            ? `<button onclick="resendPaymentLink('${r._id}')" class="btn btn-pay-link" title="Znovu poslat v√Ωzvu k platbƒõ"><i class="fa-solid fa-money-bill-wave"></i></button>`
                            : `<button onclick="resendEmail('${r._id}')" class="btn btn-resend"><i class="fa-regular fa-envelope"></i></button>`
                        }
                        ${actionBtn}
                        <button onclick="deleteRes('${r._id}')" class="btn btn-del"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById("total-revenue").innerText = tRev.toLocaleString() + " Kƒç";
            document.getElementById("total-fees").innerText = "-" + tFee.toLocaleString() + " Kƒç";
            document.getElementById("total-tax").innerText = "-" + tTax.toLocaleString() + " Kƒç";
            document.getElementById("total-net").innerText = tNet.toLocaleString() + " Kƒç";
            document.getElementById("res-count").innerText = data.length;
        }

        function changeAdminMonth(delta) {
            viewMonth += delta;
            if (viewMonth > 11) { viewMonth = 0; viewYear++; }
            else if (viewMonth < 0) { viewMonth = 11; viewYear--; }
            renderAdminCalendar();
        }

        function renderAdminCalendar() {
            const grid = document.getElementById("admin-cal-grid");
            const label = document.getElementById("admin-cal-month");
            grid.innerHTML = "";

            const monthNames = ["Leden", "√önor", "B≈ôezen", "Duben", "Kvƒõten", "ƒåerven", "ƒåervenec", "Srpen", "Z√°≈ô√≠", "≈ò√≠jen", "Listopad", "Prosinec"];
            label.innerText = `${monthNames[viewMonth]} ${viewYear}`;

            ["PO","√öT","ST","ƒåT","P√Å","SO","NE"].forEach(d => {
                grid.innerHTML += `<div class="cal-weekday">${d}</div>`;
            });

            const firstDay = new Date(viewYear, viewMonth, 1).getDay();
            const shift = (firstDay === 0) ? 6 : firstDay - 1;
            const daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();

            for (let i = 0; i < shift; i++) grid.innerHTML += `<div class="cal-day empty"></div>`;

            const todayStr = new Date().toLocaleDateString('en-CA');
            const startVal = document.getElementById("admin-start").value;
            const endVal = document.getElementById("admin-end").value;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = new Date(viewYear, viewMonth, d).toLocaleDateString('en-CA');
                const dayEl = document.createElement("div");
                dayEl.className = "cal-day";
                dayEl.innerText = d;
                
                if (dateStr === todayStr) dayEl.classList.add("today");

                if (dateStr === startVal || dateStr === endVal || (startVal && endVal && dateStr > startVal && dateStr < endVal)) {
                    dayEl.classList.add("selected");
                }
                
                const bg = getDayOccupancyStyle(dateStr);
                if (bg) dayEl.style.background = bg;

                if (dateStr < todayStr) dayEl.classList.add("past");
                else {
                    dayEl.onclick = () => {
                        const s = document.getElementById("admin-start");
                        const e = document.getElementById("admin-end");
                        if (!s.value || (s.value && e.value)) { s.value = dateStr; e.value = ""; }
                        else { if (dateStr < s.value) s.value = dateStr; else e.value = dateStr; }
                        updateManualPriceHint(); renderAdminCalendar();
                    };
                }
                grid.appendChild(dayEl);
            }
        }

        function getDayOccupancyStyle(dateStr) {
            let timeline = [];
            allReservations.forEach(res => {
                if (res.paymentStatus === 'CANCELED') return;
                if (dateStr >= res.startDate && dateStr <= res.endDate) {
                    let sP = 0, eP = 100;
                    if (res.startDate === dateStr) sP = Math.round((parseInt(res.time.split(':')[0]) / 24) * 100);
                    if (res.endDate === dateStr) eP = Math.round((parseInt((res.endTime || res.time).split(':')[0]) / 24) * 100);
                    timeline.push({ s: sP, e: eP });
                }
            });
            if (timeline.length === 0) return null;
            let stops = [];
            timeline.forEach(t => { 
                if(t.s === 0 && t.e === 100) return stops.push(`#bfa37c 0%`, `#bfa37c 100%`);
                stops.push(`white 0%`, `white ${t.s}%`, `#bfa37c ${t.s}%`, `#bfa37c ${t.e}%`, `white ${t.e}%`, `white 100%`);
            });
            return `linear-gradient(90deg, ${stops.join(", ")})`;
        }

        async function archiveRes(id) {
            const reason = prompt("Zadejte d≈Øvod ukonƒçen√≠ PINu (bude odesl√°n z√°kazn√≠kovi):", "Ukonƒçeno po dohodƒõ");
            if (reason !== null) { 
                await fetch(`/admin/reservations/${id}/archive`, { 
                    method: "POST", 
                    headers: { "x-admin-password": localStorage.getItem("adminPass"), "Content-Type": "application/json" },
                    body: JSON.stringify({ reason: reason }) 
                });
                alert("Ukonƒçeno a email odesl√°n.");
                checkAuth();
            }
        }

        async function deleteRes(id) { if(confirm("Smazat?")) { await fetch(`/admin/reservations/${id}`, { method: "DELETE", headers: { "x-admin-password": localStorage.getItem("adminPass") } }); checkAuth(); } }

        async function resendEmail(id) { await fetch(`/admin/reservations/${id}/resend-email`, { method: "POST", headers: { "x-admin-password": localStorage.getItem("adminPass") } }); alert("Odesl√°no"); }
        
        async function renewRes(id) {
            if(!confirm("Obnovit p≈Øvodn√≠ term√≠n a vygenerovat nov√Ω PIN?")) return;
            const res = await fetch("/admin/reservations/" + id, {
                method: "PUT",
                headers: { "Content-Type": "application/json", "x-admin-password": localStorage.getItem("adminPass") },
                body: JSON.stringify({ restore: true })
            });

            if(res.ok) { alert("Obnoveno."); checkAuth(); } 
            else if (res.status === 409) { alert("CHYBA: Nelze obnovit! Term√≠n je ji≈æ obsazen jinou rezervac√≠."); } 
            else { alert("Chyba p≈ôi obnovov√°n√≠."); }
        }

        async function resendPaymentLink(id) {
            if(!confirm("Znovu poslat email s odkazem na platbu?")) return;
            const res = await fetch(`/admin/reservations/${id}/resend-extension-email`, { method: "POST", headers: { "x-admin-password": localStorage.getItem("adminPass") } });
            if(res.ok) alert("Odesl√°no"); else alert("Chyba");
        }

        async function manualReserve() {
            const body = {
                startDate: document.getElementById("admin-start").value,
                endDate: document.getElementById("admin-end").value,
                time: document.getElementById("admin-time").value,
                name: document.getElementById("admin-name").value,
                email: document.getElementById("admin-email").value,
                phone: document.getElementById("admin-phone").value,
                price: document.getElementById("admin-price").value
            };
            const res = await fetch("/reserve-range", { 
                method: "POST", headers: { "Content-Type": "application/json", "x-admin-password": localStorage.getItem("adminPass") }, 
                body: JSON.stringify(body) 
            });
            if (res.ok) { alert("Vytvo≈ôeno."); checkAuth(); } else { alert("Chyba."); }
        }

        function openEditModal(r) {
            document.getElementById('edit-id').value = r._id;
            document.getElementById('edit-start').value = r.startDate;
            document.getElementById('edit-end').value = r.endDate;
            document.getElementById('edit-time').value = r.time;
            document.getElementById('edit-original-price').value = r.price;
            document.getElementById('edit-price').value = r.price;
            
            document.getElementById('edit-name').value = r.name || "";
            document.getElementById('edit-email').value = r.email || "";
            document.getElementById('edit-phone').value = r.phone || "";

            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }
        
        async function saveContactInfoOnly() {
            const id = document.getElementById('edit-id').value;
            const payload = {
                startDate: document.getElementById('edit-start').value,
                endDate: document.getElementById('edit-end').value,
                time: document.getElementById('edit-time').value,
                price: document.getElementById('edit-original-price').value,
                name: document.getElementById('edit-name').value,
                email: document.getElementById('edit-email').value,
                phone: document.getElementById('edit-phone').value
            };
            try {
                const res = await fetch("/admin/reservations/" + id, { method: "PUT", headers: { "Content-Type": "application/json", "x-admin-password": localStorage.getItem("adminPass") }, body: JSON.stringify(payload) });
                if(res.ok) { alert("‚úÖ Kontaktn√≠ √∫daje ulo≈æeny."); checkAuth(); } 
                else { const d = await res.json(); alert("‚ùå Chyba: " + (d.error || "Nezn√°m√°")); }
            } catch(e) { alert("Chyba: " + e.message); }
        }

        async function saveEditFree() {
            const res = await fetch("/admin/reservations/" + document.getElementById('edit-id').value, {
                method: "PUT", headers: { "Content-Type": "application/json", "x-admin-password": localStorage.getItem("adminPass") },
                body: JSON.stringify({
                    startDate: document.getElementById('edit-start').value,
                    endDate: document.getElementById('edit-end').value,
                    time: document.getElementById('edit-time').value,
                    price: document.getElementById('edit-price').value,
                    name: document.getElementById('edit-name').value,
                    email: document.getElementById('edit-email').value,
                    phone: document.getElementById('edit-phone').value
                })
            });
            if(res.ok) { alert("Ulo≈æeno."); closeEditModal(); checkAuth(); }
        }
        
        async function saveEditPayment() {
            const oldP = parseFloat(document.getElementById('edit-original-price').value) || 0;
            const newP = parseFloat(document.getElementById('edit-price').value) || 0;
            if (newP <= oldP) { alert("Pro v√Ωzvu k platbƒõ mus√≠ b√Ωt nov√° cena vy≈°≈°√≠."); return; }
            if(!confirm(`Odeslat v√Ωzvu k √∫hradƒõ ${newP - oldP} Kƒç?`)) return;
            
            const id = document.getElementById('edit-id').value;
            const body = {
                startDate: document.getElementById('edit-start').value,
                endDate: document.getElementById('edit-end').value,
                time: document.getElementById('edit-time').value,
                endTime: document.getElementById('edit-endtime').value,
                newTotalPrice: newP
            };
            
            try {
                const res = await fetch(`/admin/reservations/${id}/create-extension`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "x-admin-password": localStorage.getItem("adminPass") },
                    body: JSON.stringify(body)
                });
                if(res.ok) { alert("V√Ωzva odesl√°na."); closeEditModal(); checkAuth(); }
                else alert("Chyba.");
            } catch(e) { alert("Chyba."); }
        }

        function calcDiff() {
            const oldP = parseFloat(document.getElementById('edit-original-price').value) || 0;
            const newP = parseFloat(document.getElementById('edit-price').value) || 0;
            const diff = newP - oldP;
            const el = document.getElementById('price-diff');
            if(diff > 0) { el.innerText = `Doplatek: ${diff} Kƒç`; el.style.color = "red"; }
            else if(diff < 0) { el.innerText = `P≈ôeplatek: ${Math.abs(diff)} Kƒç`; el.style.color = "green"; }
            else { el.innerText = "Cena beze zmƒõny"; el.style.color = "black"; }
        }

        function downloadCSV() {
            if (!currentFilteredData || currentFilteredData.length === 0) { alert("≈Ω√°dn√° data."); return; }
            let csv = "\uFEFFID Rezervace;Jm√©no;Email;Telefon;Vytvo≈ôeno;Term√≠n Od;Term√≠n Do;Cena (Kƒç);Poplatek GoPay;Da≈à;ƒåist√Ω Zisk;Stav;PIN\n";
            currentFilteredData.forEach(r => {
                let vals = computedDataMap[r._id] || { fee: 0, tax: 0, net: 0 };
                let row = [
                    r.reservationCode, `"${r.name}"`, r.email, r.phone,
                    new Date(r.created).toLocaleDateString("cs-CZ"),
                    new Date(r.startDate).toLocaleDateString("cs-CZ") + " " + r.time,
                    new Date(r.endDate).toLocaleDateString("cs-CZ") + " " + (r.endTime || r.time),
                    r.price || 0, vals.fee, vals.tax, vals.net, r.paymentStatus, r.passcode
                ];
                csv += row.join(";") + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "rezervace_vozik.csv";
            link.click();
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
