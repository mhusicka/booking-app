<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Voz√≠k 24/7</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-box { max-width: 1100px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .login-screen { text-align: center; margin-top: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; margin-bottom: 30px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #bfa37c; text-transform: uppercase; font-size: 0.8rem; }
        tr:hover { background: #fafafa; }
        h3.section-title { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 40px; color: #444; }
        h3.active-title { border-color: #28a745; color: #28a745; }
        h3.archive-title { border-color: #999; color: #999; }
        .btn-delete { background: #ffcccc; color: #a00; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .action-group { display: flex; gap: 5px; align-items: center; }
        .action-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.85rem; }
        .btn-execute { background: #333; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.85rem; }
        .pin-cell { color: #28a745; font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        .pin-inactive { color: #999; text-decoration: line-through; }
        .pin-error { color: red; font-weight: bold; }
        .bulk-action-bar { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="login-section" class="main-container login-screen">
        <h1>Administrace</h1>
        <div class="form-group" style="max-width: 300px; margin: 0 auto;">
            <label>Heslo:</label>
            <input type="password" id="admin-pass">
            <button onclick="login()" class="btn-pay" style="margin-top:10px;">Vstoupit</button>
        </div>
    </div>
    <div id="data-section" class="admin-box" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h2>Spr√°va Rezervac√≠</h2>
            <div><button onclick="loadReservations()" class="btn-small">Obnovit</button> <button onclick="logout()" class="btn-small">Odhl√°sit</button></div>
        </div>
        
        <div class="bulk-action-bar">
            <label>Vybr√°no: <span id="selected-count">0</span></label>
            <button class="btn-delete" onclick="bulkDelete()">SMAZAT VYBRAN√â</button>
        </div>

        <h3 class="section-title active-title">üü¢ Aktivn√≠ (Budouc√≠)</h3>
        <table>
            <thead><tr><th><input type="checkbox" id="select-active-all" onclick="toggleAll('active')"></th><th>K√≥d</th><th>Term√≠n</th><th>PIN</th><th>Jm√©no</th><th>Akce</th></tr></thead>
            <tbody id="table-body-active"></tbody>
        </table>

        <h3 class="section-title archive-title">üìÇ Archiv (Probƒõhl√©)</h3>
        <table>
            <thead><tr><th><input type="checkbox" id="select-archive-all" onclick="toggleAll('archive')"></th><th>K√≥d</th><th>Term√≠n</th><th>PIN</th><th>Jm√©no</th><th>Akce</th></tr></thead>
            <tbody id="table-body-archive"></tbody>
        </table>
    </div>

    <script>
        const API_BASE = ""; 
        
        function login() { const p = document.getElementById("admin-pass").value; loadReservations(p); }
        function logout() { localStorage.removeItem("adminPass"); location.reload(); }

        async function loadReservations(pwd = null) {
            const password = pwd || localStorage.getItem("adminPass");
            try {
                const res = await fetch(`${API_BASE}/admin/reservations`, { headers: { "x-admin-password": password } });
                if (res.status === 403) { alert("≈†patn√© heslo!"); return; }
                const data = await res.json();
                renderTables(data);
                document.getElementById("login-section").style.display = "none";
                document.getElementById("data-section").style.display = "block";
                localStorage.setItem("adminPass", password);
            } catch (e) { alert("Chyba spojen√≠."); }
        }

        function renderTables(data) {
            const activeBody = document.getElementById("table-body-active");
            const archiveBody = document.getElementById("table-body-archive");
            activeBody.innerHTML = ""; archiveBody.innerHTML = "";
            data.sort((a, b) => new Date(b.created) - new Date(a.created)); 

            const now = new Date();

            data.forEach(r => {
                const start = new Date(r.startDate).toLocaleDateString("cs-CZ");
                const end = new Date(r.endDate).toLocaleDateString("cs-CZ");
                let dateStr = r.startDate !== r.endDate ? `${start} ‚Äì ${end} (${r.time})` : `${start} (${r.time})`;
                
                // ROZHODOVAC√ç LOGIKA: AKTIVN√ç vs ARCHIV
                // Rezervace je aktivn√≠, pokud jej√≠ KONEC je v budoucnosti
                const endTime = new Date(`${r.endDate}T${r.time}:00`);
                const isActiveTime = endTime > now;

                let pinHtml = "";
                if (r.keyboardPwdId) pinHtml = `<span class="pin-cell">${r.passcode}</span>`;
                else if (isActiveTime) pinHtml = `<span class="pin-error">CHYBA PINU</span> <small>(${r.passcode})</small>`;
                else pinHtml = `<span class="pin-inactive">${r.passcode}</span>`;

                const tr = document.createElement("tr");
                const actionHtml = `
                    <div class="action-group">
                        <select id="act-${r._id}" class="action-select">
                            <option value="">-- Akce --</option>
                            ${isActiveTime ? '<option value="archive">Ukonƒçit (Archivovat)</option>' : ''}
                            <option value="delete">Smazat</option>
                        </select>
                        <button onclick="executeAction('${r._id}')" class="btn-execute">OK</button>
                    </div>`;

                tr.innerHTML = `
                    <td><input type="checkbox" data-id="${r._id}" onclick="updateSelectedCount()"></td>
                    <td><strong>${r.reservationCode || "-"}</strong></td>
                    <td>${dateStr}</td>
                    <td>${pinHtml}</td>
                    <td>${r.name}<br><small>${r.phone}</small></td>
                    <td>${actionHtml}</td>
                `;

                if (isActiveTime) activeBody.appendChild(tr);
                else archiveBody.appendChild(tr);
            });
            if (!activeBody.innerHTML) activeBody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#999'>≈Ω√°dn√© rezervace</td></tr>";
            if (!archiveBody.innerHTML) archiveBody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:#999'>Pr√°zdno</td></tr>";
        }

        function toggleAll(type) {
            const chks = document.querySelectorAll(`#table-body-${type} input[type="checkbox"]`);
            const val = document.getElementById(`select-${type}-all`).checked;
            chks.forEach(c => c.checked = val);
            updateSelectedCount();
        }
        function updateSelectedCount() {
            document.getElementById('selected-count').innerText = document.querySelectorAll('tbody input:checked').length;
        }

        async function bulkDelete() {
            const ids = Array.from(document.querySelectorAll('tbody input:checked')).map(c => c.dataset.id);
            if (!ids.length || !confirm("Smazat vybran√©?")) return;
            await fetch(`${API_BASE}/admin/reservations/bulk`, {
                method: "DELETE",
                headers: { "x-admin-password": localStorage.getItem("adminPass"), "Content-Type": "application/json" },
                body: JSON.stringify({ ids })
            });
            loadReservations();
        }

        async function executeAction(id) {
            const act = document.getElementById(`act-${id}`).value;
            if (!act) return;
            if (!confirm("Prov√©st akci?")) return;
            const url = act === 'archive' ? `${API_BASE}/admin/reservations/${id}/archive` : `${API_BASE}/admin/reservations/${id}`;
            const method = act === 'archive' ? 'POST' : 'DELETE';
            await fetch(url, { method, headers: { "x-admin-password": localStorage.getItem("adminPass") } });
            loadReservations();
        }
        
        window.onload = () => { if(localStorage.getItem("adminPass")) loadReservations(); };
    </script>
</body>
</html>
