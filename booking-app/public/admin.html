<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Vozík 24/7</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .admin-box { max-width: 1600px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .login-screen { max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { color: #bfa37c; margin-top: 0; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: #555; font-weight: 600; text-transform: uppercase; font-size: 11px; }
        tr:hover { background: #fafafa; }
        
        .badge { padding: 4px 8px; border-radius: 20px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
        .b-paid { background: #d4edda; color: #155724; }
        .b-pending { background: #fff3cd; color: #856404; }
        .b-canceled { background: #f8d7da; color: #721c24; }

        .btn { padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 3px; transition: 0.2s; }
        .btn-del { background: #ffebee; color: #c62828; }
        .btn-del:hover { background: #ffcdd2; }
        .btn-arch { background: #e3f2fd; color: #1565c0; }
        .btn-arch:hover { background: #bbdefb; }
        .btn-resend { background: #fff3e0; color: #ef6c00; }
        .btn-resend:hover { background: #ffe0b2; }
        
        .btn-export { background: #28a745; color: white; padding: 8px 16px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn-export:hover { background: #218838; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 13px; }
        .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-main { background: #bfa37c; color: white; padding: 12px 20px; font-size: 16px; width: 100%; font-weight: bold; }
        .btn-main:hover { background: #a68b68; }

        /* DASHBOARD STATS */
        .dashboard-stats { display: flex; gap: 15px; margin-bottom: 20px; align-items: stretch; flex-wrap: wrap; }
        .stat-card { background: white; border: 1px solid #eee; padding: 15px 20px; border-radius: 8px; min-width: 180px; flex: 1; }
        .stat-card h3 { margin: 0 0 5px 0; font-size: 11px; text-transform: uppercase; color: #888; letter-spacing: 1px; }
        .stat-card .value { font-size: 20px; font-weight: 800; color: #333; }
        
        .card-dark { background: #333; color: white; border: none; }
        .card-dark .value { color: #bfa37c; }
        .card-red .value { color: #dc3545; }
        .card-orange .value { color: #fd7e14; }
        .card-green .value { color: #28a745; }
        
        .month-filters { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .filter-btn { background: white; border: 1px solid #ddd; color: #555; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; }
        .filter-btn:hover { border-color: #bfa37c; color: #bfa37c; }
        .filter-btn.active { background: #bfa37c; color: white; border-color: #bfa37c; }

        .settings-bar { display: flex; align-items: center; gap: 15px; background: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px; }
        .settings-bar input { width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }

        tr.active-now { background: #e8f5e9; border-left: 4px solid #28a745; }
    </style>
</head>
<body>

    <div id="login-section" class="login-screen">
        <h2>Admin přihlášení</h2>
        <input type="password" id="admin-pass" placeholder="Heslo" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px;">
        <button onclick="login()" class="btn btn-main">Vstoupit</button>
    </div>

    <div id="admin-content" style="display: none;">
        
        <div class="admin-box">
            <h1>
                <span><i class="fa-solid fa-chart-line"></i> Přehled rezervací</span>
                <div>
                    <button onclick="downloadCSV()" class="btn btn-export"><i class="fa-solid fa-file-excel"></i> Export pro účetní</button>
                    <button onclick="logout()" class="btn btn-del">Odhlásit</button>
                </div>
            </h1>

            <div class="settings-bar">
                <i class="fa-solid fa-calculator"></i>
                <label>Sazba daně z příjmu:</label>
                <input type="number" id="tax-rate" value="15" onchange="recalculateAll()"> %
                <span style="color:#666; margin-left: 10px;">(Tato daň se odečte z hrubé tržby pro výpočet čistého zisku)</span>
            </div>

            <div class="month-filters" id="month-filters-container"></div>

            <div class="dashboard-stats">
                <div class="stat-card card-dark">
                    <h3 id="revenue-title">Celková tržba (Hrubá)</h3>
                    <div class="value" id="total-revenue">0 Kč</div>
                </div>
                <div class="stat-card card-red">
                    <h3>Poplatky (GoPay)</h3>
                    <div class="value" id="total-fees">0 Kč</div>
                    <small style="font-size: 10px; color: #666;">Auto-limit 50 000 Kč</small>
                </div>
                <div class="stat-card card-orange">
                    <h3>Odhad daně</h3>
                    <div class="value" id="total-tax">0 Kč</div>
                </div>
                <div class="stat-card card-green">
                    <h3>Čistý zisk (Netto)</h3>
                    <div class="value" id="total-net">0 Kč</div>
                </div>
                <div class="stat-card">
                    <h3>Počet rezervací</h3>
                    <div class="value" id="res-count">0</div>
                </div>
            </div>

            <table id="res-table">
                <thead>
                    <tr>
                        <th>Datum</th>
                        <th>Jméno / ID</th>
                        <th>Termín</th>
                        <th>Cena (Klient)</th>
                        <th style="color:#dc3545">GoPay</th>
                        <th style="color:#fd7e14">Daň</th>
                        <th style="color:#28a745">Čistý zisk</th>
                        <th>PIN</th>
                        <th>Stav</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="admin-box" style="max-width: 600px;">
            <h2><i class="fa-solid fa-plus-circle"></i> Ruční vytvoření rezervace</h2>
            <div class="input-group"><label>Jméno</label><input id="admin-name" type="text"></div>
            <div class="input-group"><label>Email</label><input id="admin-email" type="email"></div>
            <div class="input-group"><label>Telefon</label><input id="admin-phone" type="text" value="+420 "></div>
            <div class="input-group" style="display: flex; gap: 10px;">
                <div style="flex:1"><label>Od</label><input id="admin-start" type="date"></div>
                <div style="flex:1"><label>Do</label><input id="admin-end" type="date"></div>
            </div>
            <div class="input-group"><label>Čas</label><input id="admin-time" type="time" value="08:00"></div>
            <div class="input-group"><label>Cena (Kč)</label><input id="admin-price" type="number"></div>
            <button onclick="manualReserve()" class="btn btn-main">Vytvořit a poslat PIN</button>
        </div>
    </div>

    <script>
        let allReservations = []; 
        let currentFilteredData = [];
        let computedDataMap = {}; // Uložíme si vypočítané poplatky pro ID

        // --- KONFIGURACE GOPAY (AUTOMATIKA) ---
        const STANDARD_PERCENT = 0.01; // 1%
        const STANDARD_FIXED = 1;      // 1 Kč
        const CPK_LIMIT = 50000;       // Limit pro akci "Česko platí kartou"

        function login() {
            const p = document.getElementById("admin-pass").value;
            localStorage.setItem("adminPass", p);
            checkAuth();
        }

        function logout() {
            localStorage.removeItem("adminPass");
            location.reload();
        }

        async function checkAuth() {
            const pass = localStorage.getItem("adminPass");
            if (!pass) return;

            const res = await fetch("/admin/reservations", { headers: { "x-admin-password": pass } });
            if (res.status === 403) {
                alert("Špatné heslo");
                localStorage.removeItem("adminPass");
                return;
            }
            
            allReservations = await res.json(); 
            document.getElementById("login-section").style.display = "none";
            document.getElementById("admin-content").style.display = "block";
            
            // Načíst uloženou daň
            const savedTax = localStorage.getItem("taxRate");
            if (savedTax) document.getElementById("tax-rate").value = savedTax;

            calculateFeesGlobal(); // Spočítat všechna data před filtrováním
            generateFilters();
            
            // Zkusit vybrat aktuální měsíc
            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            const hasData = allReservations.some(r => r.startDate && r.startDate.startsWith(currentMonthKey));
            
            if (hasData) {
                setTimeout(() => {
                    const btn = Array.from(document.querySelectorAll('.filter-btn')).find(b => b.innerText.includes(getMonthName(now.getMonth())));
                    if(btn) btn.click();
                    else filterData('ALL', document.querySelector('.filter-btn'));
                }, 100);
            } else {
                filterData('ALL', document.querySelector('.filter-btn')); 
            }
        }

        function getMonthName(mIndex) {
            const monthNames = ["Leden", "Únor", "Březen", "Duben", "Květen", "Červen", "Červenec", "Srpen", "Září", "Říjen", "Listopad", "Prosinec"];
            return monthNames[mIndex];
        }

        // --- HLAVNÍ LOGIKA VÝPOČTU POPLATKŮ ---
        function calculateFeesGlobal() {
            computedDataMap = {};
            const monthlyRevenue = {};

            // Musíme procházet chronologicky od nejstarší, abychom správně určili překročení limitu 50k
            const chronological = [...allReservations].sort((a,b) => new Date(a.startDate) - new Date(b.startDate));

            chronological.forEach(r => {
                if (r.paymentStatus !== 'PAID') {
                    computedDataMap[r._id] = { fee: 0, tax: 0, net: 0 };
                    return;
                }

                // Klíč měsíce (YYYY-MM)
                const mKey = r.startDate.substring(0, 7);
                if (!monthlyRevenue[mKey]) monthlyRevenue[mKey] = 0;

                let price = r.price || 0;
                let fee = 0;
                let currentTotal = monthlyRevenue[mKey];

                // Automatika CPK: Pokud jsme pod 50k, poplatek je 0
                if (currentTotal < CPK_LIMIT) {
                    let freeSpace = CPK_LIMIT - currentTotal;
                    if (price <= freeSpace) {
                        fee = 0; // Vejde se do limitu
                    } else {
                        // Část je zdarma, zbytek se daní
                        let taxedPart = price - freeSpace;
                        fee = Math.round(taxedPart * STANDARD_PERCENT + STANDARD_FIXED);
                    }
                } else {
                    // Už jsme nad limitem
                    fee = Math.round(price * STANDARD_PERCENT + STANDARD_FIXED);
                }

                // Výpočet daně z příjmu (z hrubé částky)
                const taxRate = parseFloat(document.getElementById("tax-rate").value) || 0;
                let tax = Math.round(price * (taxRate / 100));

                let net = price - fee - tax;

                monthlyRevenue[mKey] += price;
                computedDataMap[r._id] = { fee, tax, net };
            });
        }

        function recalculateAll() {
            localStorage.setItem("taxRate", document.getElementById("tax-rate").value);
            calculateFeesGlobal();
            const activeBtn = document.querySelector('.filter-btn.active');
            if (activeBtn) activeBtn.click();
            else filterData('ALL', null);
        }

        function generateFilters() {
            const container = document.getElementById('month-filters-container');
            container.innerHTML = `<button class="filter-btn active" onclick="filterData('ALL', this)">VŠE</button>`;
            const months = new Set();
            allReservations.forEach(r => { if(r.startDate) months.add(r.startDate.substring(0, 7)); });
            Array.from(months).sort().reverse().forEach(m => {
                const [year, month] = m.split('-');
                const label = `${getMonthName(parseInt(month) - 1)} ${year}`;
                container.innerHTML += `<button class="filter-btn" onclick="filterData('${m}', this)">${label}</button>`;
            });
        }

        function filterData(monthKey, btnElement) {
            if(btnElement) {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btnElement.classList.add('active');
            }

            const titleEl = document.getElementById('revenue-title');
            if (monthKey === 'ALL') {
                currentFilteredData = allReservations;
                titleEl.innerText = "Celková tržba (Hrubá)";
            } else {
                currentFilteredData = allReservations.filter(r => r.startDate.startsWith(monthKey));
                const [year, month] = monthKey.split('-');
                titleEl.innerText = `Tržba: ${getMonthName(parseInt(month) - 1)} ${year}`;
            }

            renderTable(currentFilteredData);
        }

        function renderTable(data) {
            const tbody = document.querySelector("#res-table tbody");
            tbody.innerHTML = "";

            let totalRev = 0, totalFees = 0, totalTax = 0, totalNet = 0;
            // Řadíme od nejnovější pro zobrazení
            data.sort((a,b) => new Date(b.created) - new Date(a.created));

            data.forEach(r => {
                let statusClass = "b-pending", statusText = "Čeká";
                let vals = computedDataMap[r._id] || { fee: 0, tax: 0, net: 0 };
                let price = r.price || 0;

                if (r.paymentStatus === 'PAID') { 
                    statusClass = "b-paid"; statusText = "Zaplaceno"; 
                    totalRev += price;
                    totalFees += vals.fee;
                    totalTax += vals.tax;
                    totalNet += vals.net;
                } else if (r.paymentStatus === 'CANCELED') { 
                    statusClass = "b-canceled"; statusText = "Zrušeno"; 
                }

                const todayStr = new Date().toISOString().split('T')[0];
                const isActive = (r.startDate <= todayStr && r.endDate >= todayStr && r.paymentStatus === 'PAID');

                const tr = document.createElement("tr");
                tr.className = isActive ? 'active-now' : '';
                tr.innerHTML = `
                    <td>${new Date(r.created).toLocaleDateString("cs-CZ")}</td>
                    <td><b>${r.name}</b><br><small style="color:#999">${r.reservationCode}</small></td>
                    <td>${new Date(r.startDate).toLocaleDateString("cs-CZ")} - ${new Date(r.endDate).toLocaleDateString("cs-CZ")}</td>
                    <td style="font-weight:bold">${price} Kč</td>
                    <td style="color:${vals.fee===0?'#ccc':'#dc3545'}">-${vals.fee} Kč</td>
                    <td style="color:#fd7e14">-${vals.tax} Kč</td>
                    <td style="color:#28a745; font-weight:bold">${vals.net} Kč</td>
                    <td style="font-family:monospace;">${r.passcode}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <button onclick="resendEmail('${r._id}')" class="btn btn-resend"><i class="fa-regular fa-envelope"></i></button>
                        <button onclick="archiveRes('${r._id}')" class="btn btn-arch"><i class="fa-solid fa-box-archive"></i></button>
                        <button onclick="deleteRes('${r._id}')" class="btn btn-del"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById("total-revenue").innerText = totalRev.toLocaleString("cs-CZ") + " Kč";
            document.getElementById("total-fees").innerText = "-" + totalFees.toLocaleString("cs-CZ") + " Kč";
            document.getElementById("total-tax").innerText = "-" + totalTax.toLocaleString("cs-CZ") + " Kč";
            document.getElementById("total-net").innerText = totalNet.toLocaleString("cs-CZ") + " Kč";
            document.getElementById("res-count").innerText = data.length;
        }

        // --- EXPORT ---
        function downloadCSV() {
            if (!currentFilteredData || currentFilteredData.length === 0) { alert("Žádná data."); return; }
            let csv = "\uFEFFID Rezervace;Jméno;Email;Vytvořeno;Termín;Cena (Kč);Poplatek GoPay;Daň;Čistý Zisk;Stav;PIN\n";
            
            currentFilteredData.forEach(r => {
                let vals = computedDataMap[r._id] || { fee: 0, tax: 0, net: 0 };
                let row = [
                    r.reservationCode, `"${r.name}"`, r.email,
                    new Date(r.created).toLocaleDateString("cs-CZ"),
                    `${new Date(r.startDate).toLocaleDateString("cs-CZ")} - ${new Date(r.endDate).toLocaleDateString("cs-CZ")}`,
                    r.price || 0, vals.fee, vals.tax, vals.net, r.paymentStatus, r.passcode
                ];
                csv += row.join(";") + "\n";
            });

            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv;charset=utf-8;" }));
            link.download = `Export_Vozik_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        async function resendEmail(id) { if(confirm("Odeslat znovu?")) fetch(`/admin/reservations/${id}/resend-email`, { method: "POST", headers: { "x-admin-password": localStorage.getItem("adminPass") } }).then(()=>alert("OK")); }
        async function deleteRes(id) { if(confirm("Smazat?")) { await fetch(`/admin/reservations/${id}`, { method: "DELETE", headers: { "x-admin-password": localStorage.getItem("adminPass") } }); checkAuth(); } }
        async function archiveRes(id) { if(confirm("Archivovat?")) { await fetch(`/admin/reservations/${id}/archive`, { method: "POST", headers: { "x-admin-password": localStorage.getItem("adminPass") } }); checkAuth(); } }
        async function manualReserve() { /* zachováno stejné */ }

        window.onload = checkAuth;
    </script>
</body>
</html>
