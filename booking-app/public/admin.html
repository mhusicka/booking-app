<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Vozík 24/7</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        
        /* Boxy */
        .admin-box { max-width: 1400px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 30px; }
        .login-screen { max-width: 400px; margin-top: 100px; text-align: center; }
        
        h1, h2, h3 { color: #333; margin-top: 0; }
        h1 { color: #bfa37c; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 30px; }
        
        /* Formuláře */
        .form-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        input:focus, select:focus { border-color: #bfa37c; outline: none; }

        /* Mřížka formuláře pro ruční rezervaci */
        .manual-form-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            align-items: end;
        }

        /* Tlačítka */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; transition: 0.2s; font-size: 0.9rem; }
        .btn-primary { background: #333; color: white; width: 100%; }
        .btn-primary:hover { background: #bfa37c; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; background: #eee; color: #333; }
        .btn-delete { background: #ffebee; color: #c62828; }
        .btn-delete:hover { background: #ffcdd2; }
        
        .header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .search-box { position: relative; max-width: 300px; width: 100%; }
        .search-box input { padding-left: 35px; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }

        /* TABULKA (Desktop) */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: left; padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background: #f9f9f9; color: #666; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        tr:hover { background: #fafafa; }
        
        /* PIN a Statusy */
        .pin-cell { font-family: monospace; font-size: 1.1rem; font-weight: bold; color: #28a745; background: #e8f5e9; padding: 4px 8px; border-radius: 4px; display: inline-block; }
        .pin-error { color: #dc3545; background: #f8d7da; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.9rem; }
        .pin-inactive { color: #999; text-decoration: line-through; }

        /* Badge pro platby */
        .badge-pay { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: inline-block; margin-top: 4px;}
        .pay-ok { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .pay-pending { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
        .pay-error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }

        /* Akce v tabulce */
        .action-group { display: flex; gap: 5px; }
        .action-select { padding: 6px; font-size: 0.85rem; border-radius: 4px; border: 1px solid #ccc; max-width: 120px; }

        /* Sekce nadpisů */
        .section-header { display: flex; align-items: center; gap: 10px; margin-top: 40px; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .section-header h3 { margin: 0; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; color: white; font-weight: bold; }
        .badge-active { background: #28a745; }
        .badge-archive { background: #6c757d; }

        /* Drobný text */
        .meta-date { font-size: 0.8rem; color: #888; display: block; margin-top: 2px; }
        
        /* --- MOBILNÍ ZOBRAZENÍ --- */
        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            .admin-box { padding: 15px; }
            .manual-form-grid { grid-template-columns: 1fr !important; gap: 10px; }

            /* Karty místo tabulky */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; } 
            
            tr { 
                background: white; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; 
                box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 5px;
            }
            
            td { 
                border: none; position: relative; padding: 10px !important; text-align: left; 
                border-bottom: 1px solid #f8f8f8; display: flex; flex-direction: column; 
                align-items: flex-start; justify-content: center;
            }
            
            td:last-child { border-bottom: none; display: block; text-align: center; padding-top: 15px !important; }
            
            td:before { 
                position: static; width: 100%; margin-bottom: 5px; white-space: nowrap; text-align: left; 
                font-weight: bold; color: #bfa37c; content: attr(data-label); font-size: 0.75rem; 
                text-transform: uppercase; letter-spacing: 1px;
            }
            
            td:first-child { flex-direction: row; align-items: center; justify-content: space-between; background: #fcfcfc; border-bottom: 1px solid #eee; border-radius: 8px 8px 0 0; }
            td:first-child:before { width: auto; margin-bottom: 0; color: #666; }
            input[type="checkbox"] { width: 20px; height: 20px; margin: 0; }

            .action-select { width: 100%; max-width: none; margin-bottom: 10px; padding: 10px; }
            .btn-execute { width: 100%; padding: 12px; background: #333; color: white; border-radius: 6px; }
            
            .header-actions { flex-direction: column; align-items: stretch; }
            .search-box { max-width: 100%; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div id="login-section" class="admin-box login-screen">
        <h1><i class="fa-solid fa-lock"></i> Admin</h1>
        <div class="form-group">
            <input type="password" id="admin-pass" placeholder="Zadejte heslo...">
        </div>
        <button onclick="login()" class="btn btn-primary">VSTOUPIT</button>
    </div>

    <div id="data-section" style="display:none;">
        
        <div class="admin-box header-actions">
            <div style="display:flex; align-items:center; gap:15px; flex-wrap:wrap; width:100%;">
                <h2 style="margin:0;">Rezervace</h2>
                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="search-input" onkeyup="filterReservations()" placeholder="Hledat jméno, email, kód...">
                </div>
            </div>
            <div style="margin-top: 10px; display:flex; gap:10px; width:100%; justify-content: flex-end;">
                <button onclick="loadReservations()" class="btn btn-small"><i class="fa-solid fa-sync"></i> Obnovit</button> 
                <button onclick="logout()" class="btn btn-small"><i class="fa-solid fa-sign-out-alt"></i> Odhlásit</button>
            </div>
        </div>

        <div class="admin-box">
            <h3><i class="fa-solid fa-plus-circle"></i> Ruční vytvoření rezervace</h3>
            <div class="manual-form-grid">
                <div class="form-group"><label>Od:</label><input type="date" id="admin-start"></div>
                <div class="form-group"><label>Do:</label><input type="date" id="admin-end"></div>
                <div class="form-group"><label>Čas:</label><input type="time" id="admin-time" value="12:00"></div>
                <div class="form-group"><label>Jméno:</label><input type="text" id="admin-name" placeholder="Jméno"></div>
                <div class="form-group"><label>Email:</label><input type="email" id="admin-email" placeholder="@"></div>
                <div class="form-group"><label>Tel:</label><input type="text" id="admin-phone" placeholder="+420"></div>
                <div class="form-group"><label>Cena (Kč):</label><input type="number" id="admin-price" placeholder="0"></div>
                <button onclick="manualReserve()" class="btn btn-primary" style="margin-bottom: 15px; height: 46px;">VYTVOŘIT</button>
            </div>
        </div>
        
        <div class="admin-box" style="padding-top: 0;">
            <div style="padding: 15px 0; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <span>Vybráno: <strong id="selected-count">0</strong></span>
                <button class="btn btn-small btn-delete" onclick="bulkDelete()">SMAZAT VYBRANÉ</button>
            </div>

            <div class="section-header">
                <h3>Aktivní (Budoucí)</h3>
                <span class="badge badge-active" id="count-active">0</span>
            </div>
            <table id="table-active">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="select-active-all" onclick="toggleAll('active')"></th>
                        <th>Vytvořeno</th>
                        <th>Kód / Platba</th>
                        <th>Termín</th>
                        <th>PIN</th>
                        <th>Zákazník</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody id="table-body-active"></tbody>
            </table>

            <div class="section-header">
                <h3>Archiv (Proběhlé)</h3>
                <span class="badge badge-archive" id="count-archive">0</span>
            </div>
            <table id="table-archive">
                <thead>
                    <tr>
                        <th width="40"><input type="checkbox" id="select-archive-all" onclick="toggleAll('archive')"></th>
                        <th>Vytvořeno</th>
                        <th>Kód / Platba</th>
                        <th>Termín</th>
                        <th>PIN</th>
                        <th>Zákazník</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody id="table-body-archive"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_BASE = ""; 
        let allReservations = []; 
        
        function login() { const p = document.getElementById("admin-pass").value; loadReservations(p); }
        function logout() { localStorage.removeItem("adminPass"); location.reload(); }

        async function loadReservations(pwd = null) {
            const password = pwd || localStorage.getItem("adminPass");
            try {
                const res = await fetch(`${API_BASE}/admin/reservations`, { headers: { "x-admin-password": password } });
                if (res.status === 403) { alert("Špatné heslo!"); return; }
                const data = await res.json();
                
                allReservations = data;
                renderTables(data);
                
                document.getElementById("login-section").style.display = "none";
                document.getElementById("data-section").style.display = "block";
                localStorage.setItem("adminPass", password);
            } catch (e) { alert("Chyba spojení."); }
        }

        function filterReservations() {
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = allReservations.filter(r => 
                (r.name && r.name.toLowerCase().includes(term)) ||
                (r.email && r.email.toLowerCase().includes(term)) ||
                (r.reservationCode && r.reservationCode.toLowerCase().includes(term)) ||
                (r.phone && r.phone.includes(term))
            );
            renderTables(filtered);
        }

        function renderTables(data) {
            const activeBody = document.getElementById("table-body-active");
            const archiveBody = document.getElementById("table-body-archive");
            activeBody.innerHTML = ""; archiveBody.innerHTML = "";
            
            // Seřazení: Nejnovější vytvořené nahoře (podle r.created)
            data.sort((a, b) => {
                const dA = a.created ? new Date(a.created) : new Date(0);
                const dB = b.created ? new Date(b.created) : new Date(0);
                return dB - dA;
            });

            const now = new Date();
            let countAct = 0; let countArch = 0;

            data.forEach(r => {
                const start = new Date(r.startDate).toLocaleDateString("cs-CZ");
                const end = new Date(r.endDate).toLocaleDateString("cs-CZ");
                let dateStr = r.startDate !== r.endDate ? `${start}<br>⬇<br>${end}` : `${start}`;
                
                // OPRAVENO: Čteme r.created (server) místo r.createdAt
                let createdDate = "-";
                if(r.created) {
                    const c = new Date(r.created);
                    createdDate = `${c.toLocaleDateString("cs-CZ")}<br><small class="meta-date">${c.toLocaleTimeString("cs-CZ", {hour: '2-digit', minute:'2-digit'})}</small>`;
                }

                // Logika pro řazení Aktivní vs Archiv
                // Pokud je v keyboardPwdId hodnota (pin existuje), bereme to jako aktivní, jinak archiv
                // Nebo podle data:
                const endTime = new Date(`${r.endDate}T${r.time || '23:59'}:00`);
                const isActiveTime = endTime > now;

                let pinHtml = "";
                if (r.keyboardPwdId) pinHtml = `<span class="pin-cell">${r.passcode}</span>`;
                else if (isActiveTime) pinHtml = `<span class="pin-error">CHYBA PIN</span><br><small>(${r.passcode})</small>`;
                else pinHtml = `<span class="pin-inactive">${r.passcode}</span>`;

                // Platba a Cena
                let priceDisplay = r.price ? `<strong>${r.price} Kč</strong>` : "";
                let paymentBadge = "";
                
                if (r.paymentStatus === 'PAID') {
                    paymentBadge = `<span class="badge-pay pay-ok">ZAPLACENO</span>`;
                } else if (r.paymentStatus === 'PENDING') {
                    paymentBadge = `<span class="badge-pay pay-pending">ČEKÁ</span>`;
                } else if (r.paymentStatus === 'CANCELED') {
                    paymentBadge = `<span class="badge-pay pay-error">ZRUŠENO</span>`;
                } else {
                    paymentBadge = `<span class="badge-pay pay-pending" style="opacity:0.5">?</span>`;
                }

                const tr = document.createElement("tr");
                
                // Akce
                const actionHtml = `
                    <div style="display:block; width:100%">
                        <select id="act-${r._id}" class="action-select">
                            <option value="">-- Akce --</option>
                            ${isActiveTime ? '<option value="archive">Ukončit</option>' : ''}
                            <option value="delete">Smazat</option>
                        </select>
                        <button onclick="executeAction('${r._id}')" class="btn-execute">OK</button>
                    </div>`;

                tr.innerHTML = `
                    <td data-label="Vybrat"><input type="checkbox" data-id="${r._id}" onclick="updateSelectedCount()"></td>
                    <td data-label="Vytvořeno">${createdDate}</td>
                    <td data-label="Kód / Platba">
                        <div style="font-size:1.1rem; font-weight:bold;">${r.reservationCode || "-"}</div>
                        <div style="margin-top:5px;">${priceDisplay}</div>
                        ${paymentBadge}
                    </td>
                    <td data-label="Termín">${dateStr} <br><small style='color:#666'>(${r.time})</small></td>
                    <td data-label="PIN">${pinHtml}</td>
                    <td data-label="Zákazník"><strong>${r.name}</strong><br><small>${r.phone}</small><br><small style="color:#666; word-break:break-all;">${r.email}</small></td>
                    <td data-label="Akce">${actionHtml}</td>
                `;

                if (isActiveTime) { activeBody.appendChild(tr); countAct++; }
                else { archiveBody.appendChild(tr); countArch++; }
            });

            document.getElementById("count-active").innerText = countAct;
            document.getElementById("count-archive").innerText = countArch;

            if (countAct === 0) activeBody.innerHTML = "<tr><td colspan='7' style='text-align:center; color:#999; padding:20px;'>Žádné aktivní rezervace pro tento filtr</td></tr>";
            if (countArch === 0) archiveBody.innerHTML = "<tr><td colspan='7' style='text-align:center; color:#999; padding:20px;'>Archiv je prázdný</td></tr>";
        }

        async function manualReserve() {
            const startDate = document.getElementById("admin-start").value;
            const endDate = document.getElementById("admin-end").value;
            const time = document.getElementById("admin-time").value;
            const name = document.getElementById("admin-name").value;
            const email = document.getElementById("admin-email").value;
            const phone = document.getElementById("admin-phone").value;
            const price = document.getElementById("admin-price").value;

            if (!startDate || !endDate || !time || !name || !email || !phone) { alert("Vyplňte vše."); return; }
            
            if(!confirm("Opravdu vytvořit rezervaci?")) return;

            try {
                const res = await fetch(`${API_BASE}/reserve-range`, {
                    method: "POST", 
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ startDate, endDate, time, name, email, phone, price: price || 0 })
                });
                const result = await res.json();
                if (result.success) {
                    alert(`✅ Vytvořeno. PIN: ${result.pin}`);
                    loadReservations();
                    document.getElementById("admin-name").value = "";
                    document.getElementById("admin-email").value = "";
                    document.getElementById("admin-phone").value = "";
                    document.getElementById("admin-price").value = "";
                } else { alert("Chyba: " + result.error); }
            } catch (e) { alert("Chyba komunikace."); }
        }

        function toggleAll(type) {
            const chks = document.querySelectorAll(`#table-body-${type} input[type="checkbox"]`);
            const val = document.getElementById(`select-${type}-all`).checked;
            chks.forEach(c => c.checked = val);
            updateSelectedCount();
        }
        function updateSelectedCount() {
            document.getElementById('selected-count').innerText = document.querySelectorAll('tbody input:checked').length;
        }

        async function bulkDelete() {
            const ids = Array.from(document.querySelectorAll('tbody input:checked')).map(c => c.dataset.id);
            if (!ids.length) return alert("Nic není vybráno.");
            if (!confirm(`Opravdu smazat ${ids.length} rezervací?`)) return;
            
            await fetch(`${API_BASE}/admin/reservations/bulk`, {
                method: "DELETE",
                headers: { "x-admin-password": localStorage.getItem("adminPass"), "Content-Type": "application/json" },
                body: JSON.stringify({ ids })
            });
            loadReservations();
        }

        async function executeAction(id) {
            const act = document.getElementById(`act-${id}`).value;
            if (!act) return;
            
            let msg = act === 'delete' ? "Opravdu SMAZAT tuto rezervaci?" : "Ukončit rezervaci a přesunout do archivu?";
            if (!confirm(msg)) return;

            const url = act === 'archive' ? `${API_BASE}/admin/reservations/${id}/archive` : `${API_BASE}/admin/reservations/${id}`;
            const method = act === 'archive' ? 'POST' : 'DELETE';
            
            await fetch(url, { method, headers: { "x-admin-password": localStorage.getItem("adminPass") } });
            loadReservations();
        }
        
        window.onload = () => { if(localStorage.getItem("adminPass")) loadReservations(); };
    </script>
</body>
</html>
