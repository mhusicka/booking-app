<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Voz칤k 24/7</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        .admin-box { max-width: 1100px; margin: 40px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .login-screen { text-align: center; margin-top: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; margin-bottom: 30px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; color: #bfa37c; text-transform: uppercase; font-size: 0.8rem; }
        tr:hover { background: #fafafa; }
        h3.section-title { border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-top: 40px; color: #444; }
        h3.active-title { border-color: #28a745; color: #28a745; }
        h3.archive-title { border-color: #999; color: #999; }
        .btn-delete { background: #ffcccc; color: #a00; border: none; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-delete:hover { background: #cc0000; color: white; }
        .info-row { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; justify-content: space-between; }
        .pin-cell { color: #28a745; font-weight: bold; font-family: monospace; font-size: 1.1rem; }
        .pin-inactive { color: #999; text-decoration: line-through; }
        .error-pin { color: #d9534f; font-weight: bold; }
    </style>
</head>
<body>
    <div id="login-section" class="main-container login-screen">
        <h1>Administrace</h1>
        <div class="form-group" style="max-width: 300px; margin: 0 auto;">
            <label>Zadejte admin heslo:</label>
            <input type="password" id="admin-pass">
            <button onclick="login()" class="btn-pay" style="margin-top:10px;">Vstoupit</button>
        </div>
    </div>

    <div id="data-section" class="admin-box" style="display:none;">
        <div class="info-row">
            <h2>Spr치va Rezervac칤</h2>
            <div>
                <button onclick="loadReservations()" class="btn-outline">Obnovit data</button>
                <button onclick="logout()" class="btn-outline" style="background:#ddd;">Odhl치sit</button>
            </div>
        </div>

        <h3 class="section-title active-title">游릭 Aktu치ln칤 a Budouc칤</h3>
        <table>
            <thead>
                <tr>
                    <th>#K칩d</th>
                    <th>Term칤n</th>
                    <th>PIN / Stav</th>
                    <th>Z치kazn칤k</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody id="table-body-active"></tbody>
        </table>

        <h3 class="section-title archive-title">游늭 Archiv (Minul칠)</h3>
        <table>
            <thead>
                <tr>
                    <th>#K칩d</th>
                    <th>Term칤n</th>
                    <th>PIN (Expirovan칳)</th>
                    <th>Z치kazn칤k</th>
                    <th>Akce</th>
                </tr>
            </thead>
            <tbody id="table-body-archive"></tbody>
        </table>
    </div>

    <script>
        const API_BASE = ""; 

        function login() {
            const password = document.getElementById("admin-pass").value;
            localStorage.setItem("adminPass", password);
            loadReservations();
        }

        function logout() {
            localStorage.removeItem("adminPass");
            location.reload();
        }

        async function loadReservations() {
            const password = localStorage.getItem("adminPass");
            if (!password) return;

            try {
                const res = await fetch(`${API_BASE}/admin/reservations`, {
                    headers: { "x-admin-password": password }
                });
                if (res.status === 403) {
                    alert("맗atn칠 heslo!");
                    logout();
                    return;
                }
                const data = await res.json();
                renderTables(data);
                
                document.getElementById("login-section").style.display = "none";
                document.getElementById("data-section").style.display = "block";
            } catch (e) {
                alert("Chyba p콏i na캜칤t치n칤 dat.");
            }
        }

        function renderTables(data) {
            const activeBody = document.getElementById("table-body-active");
            const archiveBody = document.getElementById("table-body-archive");
            activeBody.innerHTML = "";
            archiveBody.innerHTML = "";
            
            const now = Date.now();

            data.forEach(r => {
                // V칳po캜et 캜asu konce rezervace
                const endTime = new Date(`${r.endDate}T${r.time}:00`).getTime();
                const isStillActive = endTime > now; // Rezervace je aktivn칤, pokud 캜as konce je코t캩 nenastal

                // Form치tov치n칤 zobrazen칤 PINu
                let pinHtml = "";
                if (r.keyboardPwdId) {
                    pinHtml = `<span class="pin-cell">${r.passcode}</span>`;
                } else if (!isStillActive) {
                    pinHtml = `<span class="pin-inactive">${r.passcode} (Vypr코el)</span>`;
                } else {
                    // Stav: 캛asov캩 plat칤, ale v DB chyb칤 ID z치mku (chyba TTLocku)
                    pinHtml = `<span class="error-pin">丘멆잺 CHYBA Z츼MKU</span><br><small>PIN: ${r.passcode}</small>`;
                }

                const startF = new Date(r.startDate).toLocaleDateString("cs-CZ");
                const endF = new Date(r.endDate).toLocaleDateString("cs-CZ");
                const dateStr = `${startF} - ${endF} (${r.time})`;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td><strong>${r.reservationCode || "---"}</strong></td>
                    <td>${dateStr}</td>
                    <td>${pinHtml}</td>
                    <td>${r.name}<br><small>${r.phone}</small></td>
                    <td>
                        <button onclick="deleteRes('${r._id}')" class="btn-delete">Smazat</button>
                    </td>
                `;

                if (isStillActive) {
                    activeBody.appendChild(tr);
                } else {
                    archiveBody.appendChild(tr);
                }
            });

            if (!activeBody.innerHTML) activeBody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>콯치dn칠 aktivn칤 rezervace</td></tr>";
        }

        async function deleteRes(id) {
            if (!confirm("Opravdu smazat rezervaci?")) return;
            const password = localStorage.getItem("adminPass");
            try {
                await fetch(`${API_BASE}/admin/reservations/${id}`, {
                    method: 'DELETE',
                    headers: { "x-admin-password": password }
                });
                loadReservations();
            } catch (e) {
                alert("Chyba p콏i maz치n칤.");
            }
        }

        window.onload = () => {
            if (localStorage.getItem("adminPass")) loadReservations();
        };
    </script>
</body>
</html>
